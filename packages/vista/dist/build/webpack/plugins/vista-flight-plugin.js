"use strict";
/**
 * Vista Flight Client Entry Plugin
 *
 * Webpack plugin that creates separate client entries for components
 * marked with 'client load' directive. Uses Rust scanner for detection.
 *
 * This is similar to Next.js's FlightClientEntryPlugin.
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.VistaFlightPlugin = void 0;
exports.getClientModules = getClientModules;
exports.isClientModule = isClientModule;
const webpack_1 = __importDefault(require("webpack"));
const path_1 = __importDefault(require("path"));
// Plugin state for tracking client modules
const pluginState = {
    clientModules: new Map(),
    serverModules: new Map(),
};
const PLUGIN_NAME = 'VistaFlightPlugin';
class VistaFlightPlugin {
    appDir;
    dev;
    constructor(options) {
        this.appDir = options.appDir;
        this.dev = options.dev;
    }
    apply(compiler) {
        // Hook into afterCompile to collect module info
        compiler.hooks.afterCompile.tap(PLUGIN_NAME, (compilation) => {
            this.collectModuleInfo(compilation, compiler);
        });
        // Hook into emit to generate client reference manifest
        compiler.hooks.emit.tapAsync(PLUGIN_NAME, (compilation, callback) => {
            this.generateClientManifest(compilation);
            callback();
        });
    }
    /**
     * Collect information about all modules and their RSC status
     */
    collectModuleInfo(compilation, compiler) {
        const modules = compilation.modules;
        const normalizedAppDir = this.appDir.replace(/\\/g, '/').toLowerCase();
        let checkedCount = 0;
        let matchedCount = 0;
        for (const mod of modules) {
            // Check if it's a NormalModule (by checking for resource property)
            const normalMod = mod;
            const resource = normalMod.resource;
            if (!resource)
                continue;
            checkedCount++;
            // Normalize paths for comparison
            const normalizedResource = resource.replace(/\\/g, '/').toLowerCase();
            // Only process app directory files
            if (!normalizedResource.includes(normalizedAppDir))
                continue;
            // Skip non-JS/TS files
            if (!/\.(tsx?|jsx?)$/i.test(resource))
                continue;
            matchedCount++;
            // Get RSC info from build info (set by vista-flight-loader)
            const buildInfo = normalMod.buildInfo;
            const rscInfo = buildInfo?.rsc;
            if (!rscInfo)
                continue;
            const moduleId = compilation.chunkGraph.getModuleId(normalMod);
            const relativePath = path_1.default.relative(this.appDir, resource);
            const moduleInfo = {
                moduleId: moduleId !== null ? moduleId : resource,
                absolutePath: resource,
                relativePath: relativePath.replace(/\\/g, '/'),
                exports: ['default'],
            };
            if (rscInfo.isClientRef) {
                pluginState.clientModules.set(resource, moduleInfo);
            }
            else {
                pluginState.serverModules.set(resource, moduleInfo);
            }
        }
        // Debug logging (only in dev mode)
        if (this.dev && process.env.VISTA_DEBUG) {
            console.log(`[Vista Flight Plugin] Found ${pluginState.clientModules.size} client, ${pluginState.serverModules.size} server modules`);
        }
    }
    /**
     * Generate client reference manifest for hydration
     */
    generateClientManifest(compilation) {
        const manifest = {
            clientModules: {},
        };
        // Build manifest from collected client modules
        pluginState.clientModules.forEach((info, resource) => {
            const componentId = path_1.default.basename(resource).replace(/\.(tsx?|jsx?)$/, '');
            manifest.clientModules[componentId] = {
                id: info.moduleId,
                chunks: ['client.js'],
                name: 'default',
            };
        });
        // Emit manifest as a JS file that sets a global
        const manifestSource = `
// Vista Client Reference Manifest
// Generated by VistaFlightPlugin
(function() {
    if (typeof window !== 'undefined') {
        window.__VISTA_CLIENT_MANIFEST__ = ${JSON.stringify(manifest, null, 2)};
    }
})();
`.trim();
        compilation.emitAsset('vista-client-manifest.js', new webpack_1.default.sources.RawSource(manifestSource));
        // Also emit as JSON for debugging
        if (this.dev) {
            compilation.emitAsset('vista-client-manifest.json', new webpack_1.default.sources.RawSource(JSON.stringify(manifest, null, 2)));
        }
    }
}
exports.VistaFlightPlugin = VistaFlightPlugin;
// Export plugin state for other modules to access
function getClientModules() {
    return pluginState.clientModules;
}
function isClientModule(resourcePath) {
    return pluginState.clientModules.has(resourcePath);
}
exports.default = VistaFlightPlugin;
